- name: Partition and format NVMe disks for Raspberry Pi
  hosts: ether_nodes
  become: true
  vars:
    boot_partition_size_mb: 538     # 538 MiB = 512 MB
    root_partition_size_mb: 21475   # 21475 MiB = 20 GB
  tasks:
    - name: Ask for confirmation
      ansible.builtin.pause:
        prompt: |
          WARNING: This will destroy all data on the NVMe disk!
          Type 'yes' to continue, anything else to abort:

    - name: Find the NVMe device
      ansible.builtin.command: lsblk -ndo NAME,TYPE,MODEL
      register: lsblk_output

    - name: Set NVMe device variable
      ansible.builtin.set_fact:
        nvme_device: "/dev/{{ item.split()[0] }}"
      loop: "{{ lsblk_output.stdout_lines }}"
      when: "'disk' in item.lower() and 'nvme' in item.lower()"
      loop_control:
        loop_var: item

    - name: Debug NVMe device found
      ansible.builtin.debug:
        msg: "Detected NVMe device: {{ nvme_device }}"
    
    - name: Ask for confirmation of NVMe device
      ansible.builtin.pause:
        prompt: |
          WARNING: Is this the correct NVMe device ({{ nvme_device }})?
          Type 'yes' to continue, anything else to abort:

    - name: Check existing partition table
      ansible.builtin.command: lsblk -o NAME,PTTYPE -dn "{{ nvme_device }}"
      register: partition_table_info

    - name: Create partition table (GPT) if needed
      ansible.builtin.shell: |
        parted --script {{ nvme_device }} mklabel gpt
      args:
        executable: /bin/bash
      when: "'gpt' not in partition_table_info.stdout"

    - name: Check existing partitions
      ansible.builtin.command: lsblk -ndo NAME "{{ nvme_device }}"
      register: partition_list

    - name: Create first partition (FAT32) if missing
      community.general.parted:
        device: "{{ nvme_device }}"
        number: 1
        part_start: 0%
        part_end: "{{ boot_partition_size_mb }}MB"
        fs_type: fat32
        state: present
      when: (nvme_device | basename ~ "1") not in partition_list.stdout_lines


    - name: Create second partition (20GB EXT4) if missing
      community.general.parted:
        device: "{{ nvme_device }}"
        number: 2
        part_start: "{{ boot_partition_size_mb }}MB"
        part_end: "{{ boot_partition_size_mb + root_partition_size_mb }}MB"
        fs_type: ext4
        state: present
      when: (nvme_device | basename ~ "2") not in partition_list.stdout_lines


    - name: Check filesystems on partitions
      ansible.builtin.command: lsblk -ndo NAME,FSTYPE "{{ nvme_device }}"
      register: partition_fs_list

    - name: Format first partition as FAT32 if needed
      ansible.builtin.filesystem:
        fstype: vfat
        dev: "{{ nvme_device }}p1"
        force: true
      when: "'vfat' not in partition_fs_list.stdout"

    - name: Format second partition as EXT4 if needed
      ansible.builtin.filesystem:
        fstype: ext4
        dev: "{{ nvme_device }}p2"
        force: true
      when: "'ext4' not in partition_fs_list.stdout"

