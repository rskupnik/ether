apiVersion: batch/v1
kind: CronJob
metadata:
  name: immich-backup-orchestrator
  namespace: immich
  labels:
    components.nora/ntfy-token: enabled
spec:
  schedule: "0 2 * * *"
  
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          serviceAccountName: immich-backup-sa
          
          containers:
            - name: orchestrator
              image: bitnami/kubectl:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  echo "Scaling Immich down..."
                  kubectl scale deploy immich-server --replicas=0

                  echo "Running media backup..."
                  kubectl delete job immich-backup-media --ignore-not-found
                  kubectl apply -f /configs/backup-media-job.yaml
                  kubectl wait job/immich-backup-media --for=condition=complete --timeout=5m

                  echo "Running DB backup..."
                  kubectl delete job immich-backup-db --ignore-not-found
                  kubectl apply -f /configs/backup-db-job.yaml
                  kubectl wait job/immich-backup-db --for=condition=complete --timeout=5m

                  echo "Scaling Immich back up..."
                  kubectl scale deploy immich-server --replicas=1

                  curl \
                    -H "Authorization: Bearer $NTFY_TOKEN" \
                    -H "Priority: min" -H "Tags: white_check_mark" \
                    -d "Immich backup successful" \
                    --insecure \
                    https://ntfy.nora/backups

                  echo "Backup complete."
              envFrom: []
              volumeMounts:
                - name: job-definitions
                  mountPath: /configs
          
          volumes:
            - name: job-definitions
              configMap:
                name: immich-backup-job-definitions
